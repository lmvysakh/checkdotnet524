name: Test Multi-Arch .NET SDK Installation

on:
  workflow_dispatch:
  push :
    branches:
      - main

jobs:
  multi_arch_dotnet:
    runs-on: macos-14 # Or 'macos-latest'; ensure Apple Silicon runner.
    steps:
      - uses: actions/checkout@v4

      # Use the setup-dotnet action from the PR branch (implementing arch selection)
      - name: Setup .NET SDKs (arm64 and x64)
        uses: DataDog/setup-dotnet@architecture2
        with:
          dotnet: |
            - version: '8.0.x'
              arch: 'arm64'
            - version: '8.0.x'
              arch: 'x64'

      # Try both SDKs sequentially
      - name: Show installed dotnet SDKs (default arch = arm64)
        run: |
          dotnet --list-sdks
          dotnet --info

      # - name: Use x64 .NET SDK explicitly via path
      #   run: |
      #     echo "x64 SDK location:"
      #     DOTNET_ROOT_X64=$(find $RUNNER_TOOL_CACHE/dotnet -type d -name 'x64' | head -n1)
      #     # Use .NET x64
      #     if [ -d "$DOTNET_ROOT_X64" ]; then
      #       "$DOTNET_ROOT_X64/dotnet" --version
      #       "$DOTNET_ROOT_X64/dotnet" --info
      #     else
      #       echo "x64 SDK not found!"
      #       exit 1
      #     fi

      - name: Use arm64 .NET SDK explicitly via path
        run: |
          echo "arm64 SDK location:"
          DOTNET_ROOT_ARM64=$(find $RUNNER_TOOL_CACHE/dotnet -type d -name 'arm64' | head -n1)
          if [ -d "$DOTNET_ROOT_ARM64" ]; then
            "$DOTNET_ROOT_ARM64/dotnet" --version
            "$DOTNET_ROOT_ARM64/dotnet" --info
          else
            echo "arm64 SDK not found!"
            exit 1
          fi