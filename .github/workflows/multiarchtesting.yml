name: Test Multi-Arch .NET SDK Installation

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  multi_arch_dotnet:
    runs-on: macos-14 # Or 'macos-latest'; ensure Apple Silicon runner.
    steps:
      - uses: actions/checkout@v4

      # # Ensure Rosetta is installed to support x64 binaries
      # - name: Install Rosetta 2
      #   run: |
      #     /usr/sbin/softwareupdate --install-rosetta --agree-to-license
      
      # Install Rosetta for x64 emulation and validate the x64 SDK, downloading manually if necessary
      - name: Install .NET 8.0 SDK (x64, Rosetta)
        run: |
          /usr/sbin/softwareupdate --install-rosetta --agree-to-license
          if ! arch -x86_64 /usr/local/bin/dotnet --list-sdks 2>/dev/null | grep -q "8.0"; then
            echo "Installing .NET 8.0 SDK for x64 via manual download..."
            curl -L -o dotnet-x64.pkg https://download.visualstudio.microsoft.com/download/pr/8be9db3b-07b0-409f-a49b-c56c515bb24c/76bdb7e7f46ddafecfb81cb8d49adf99/dotnet-sdk-8.0.100-osx-x64.pkg
            sudo installer -pkg dotnet-x64.pkg -target /
          fi
          if ! arch -x86_64 /usr/local/bin/dotnet --list-sdks | grep -q "8.0"; then
            echo "x64 SDK installation failed!"
            exit 1
          fi

      # # Install ARM64 .NET SDK using Homebrew, then validate
      # - name: Install .NET 8.0 SDK (ARM64)
      #   run: |
      #     brew install --cask dotnet-sdk
      #     dotnet --list-sdks
      #     if ! dotnet --list-sdks | grep -q "8.0"; then
      #       echo "arm64 SDK installation failed!"
      #       exit 1
      #     fi

      # Use the setup-dotnet action from the PR branch (implementing arch selection)
      - name: Setup .NET SDKs (arm64 and x64)
        uses: DataDog/setup-dotnet@architecture2
        with:
          dotnet: |
            - version: '8.0.x'
              arch: 'arm64'
            - version: '8.0.x'
              arch: 'x64'

      # Try both SDKs sequentially
      - name: Show installed dotnet SDKs (default arch = arm64)
        run: |
          dotnet --list-sdks
          dotnet --info

      - name: Verify arm64 .NET SDK installation
        run: |
          echo "Installed SDKs:"
          dotnet --list-sdks
          if dotnet --list-sdks | grep -q "8.0"; then
            dotnet --info
          else
            echo "arm64 SDK not found!"
            exit 1
          fi

      - name: Verify x64 .NET SDK installation (via Rosetta)
        run: |
          if ! arch -x86_64 which dotnet 2>/dev/null; then
            echo "No x64 dotnet binary installed on this runner. x64 SDK validation will be skipped."
            exit 0
          fi
          if arch -x86_64 dotnet --list-sdks | grep -q "8.0"; then
            arch -x86_64 dotnet --info
            echo "x64 .NET SDK is available via Rosetta."
          else
            echo "x64 SDK not found via Rosetta!"
            exit 1
          fi